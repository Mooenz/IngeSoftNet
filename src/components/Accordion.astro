---
export interface Props {
	idElement?: string;
}

const { idElement = 'accordion' } = Astro.props;
---

<div class="accordion mt-10" id={idElement}>
	<slot />
</div>

<script>
	function initAccordion(accordionId: string) {
		const IDELEMENT = document.getElementById(accordionId);

		if (!IDELEMENT) {
			return;
		}

		// NUEVO: Ajustar los estados iniciales
		const allItems = IDELEMENT.querySelectorAll('.accordion-item');
		allItems.forEach((item) => {
			const content = item.querySelector('.accordion-content');
			if (content instanceof HTMLElement) {
				if (item.classList.contains('active')) {
					// Si tiene active, expandir
					content.style.maxHeight = content.scrollHeight + 'px';
				} else {
					// Si no tiene active, colapsar
					content.style.maxHeight = '0';
				}
			}
		});

		const headers = IDELEMENT.querySelectorAll('.accordion-header');

		if (headers.length === 0) {
			console.warn('⚠️ No hay headers en:', accordionId);
			return;
		}

		headers.forEach((header) => {
			const handleClick = function (this: HTMLElement) {
				const item = this.parentElement;
				if (!item) return;
				const content = item.querySelector('.accordion-content');

				// Cerrar todos los items del acordeón
				IDELEMENT.querySelectorAll('.accordion-item').forEach((otherItem) => {
					if (otherItem !== item) {
						otherItem.classList.remove('active');
						const otherContent = otherItem.querySelector('.accordion-content');
						if (otherContent instanceof HTMLElement) {
							otherContent.style.maxHeight = '0';
						}
					}
				});

				// Toggle del item actual
				if (item.classList.contains('active')) {
					item.classList.remove('active');
					if (content instanceof HTMLElement) {
						content.style.maxHeight = '0';
					}
				} else {
					item.classList.add('active');
					if (content instanceof HTMLElement) {
						content.style.maxHeight = content.scrollHeight + 'px';
					}
				}
			};

			header.removeEventListener('click', handleClick);
			header.addEventListener('click', handleClick);
		});
	}

	function initAllAccordions() {
		const allAccordions = document.querySelectorAll('.accordion[id]');

		allAccordions.forEach((accordion) => {
			const id = accordion.getAttribute('id');
			if (id) {
				initAccordion(id);
			}
		});
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initAllAccordions);
	} else {
		initAllAccordions();
	}

	document.addEventListener('astro:page-load', () => {
		setTimeout(initAllAccordions, 50);
	});

	document.addEventListener('astro:after-swap', () => {
		setTimeout(initAllAccordions, 50);
	});
</script>

<style is:global>
	.accordion-content {
		max-height: 0;
		overflow: hidden;
		transition: max-height 0.3s ease;
	}

	.accordion-item.active .accordion-content {
		max-height: none;
	}

	.accordion-header {
		cursor: pointer;
	}

	.accordion-item .accordion-header i {
		transition:
			transform 0.3s ease-in-out,
			color 0.3s ease-in-out;
	}

	.accordion-item.active .accordion-header i {
		transform: rotate(135deg);
	}
</style>
