---
import Modal from '@components/Modal.astro';
---

<form id="contactForm" class="flex flex-col gap-6" novalidate>
	<div class="flex flex-col lg:flex-row lg:items-center gap-6">
		<!-- Nombres -->
		<div class="w-full">
			<label for="nombreContacto" class="block mb-2">Nombres <span class="text-primary">*</span></label>
			<div class="relative border-1 border-gray-400 rounded-full">
				<input class="ps-10 pr-4 py-4 w-full rounded-full" type="text" name="nombreContacto" id="nombreContacto" placeholder="" maxlength="50" autocomplete="given-name" />
				<i class="fi icon fi-tr-user-check absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
				<span id="error-nombreContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
			</div>
		</div>

		<!-- Apellidos -->
		<div class="w-full">
			<label for="apellidoContacto" class="block mb-2">Apellidos <span class="text-primary">*</span></label>
			<div class="relative border-1 border-gray-400 rounded-full">
				<input class="ps-10 pr-4 py-4 w-full rounded-full" type="text" name="apellidoContacto" id="apellidoContacto" placeholder="" maxlength="50" autocomplete="family-name" />
				<i class="fi icon fi-tr-user-check absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
				<span id="error-apellidoContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
			</div>
		</div>
	</div>

	<div class="flex flex-col lg:flex-row lg:items-center gap-6">
		<!-- Teléfono -->
		<div class="w-full">
			<label for="telefonoContacto" class="block mb-2">Teléfono <span class="text-primary">*</span></label>
			<div class="relative border-1 border-gray-400 rounded-full">
				<input class="ps-10 pr-4 py-4 w-full rounded-full" type="tel" name="telefonoContacto" id="telefonoContacto" placeholder="" maxlength="10" inputmode="numeric" pattern="[0-9]*" autocomplete="tel" />
				<i class="fi icon fi-tr-phone-call absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
				<span id="error-telefonoContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
			</div>
		</div>

		<!-- Asunto -->
		<div class="w-full">
			<label for="asuntoContacto" class="block mb-2">Asunto <span class="text-primary">*</span></label>
			<div class="relative border-1 border-gray-400 rounded-full ps-10">
				<select class="pr-4 py-4 w-full" name="asuntoContacto" id="asuntoContacto" autocomplete="off">
					<option value="" disabled selected></option>
					<option value="informacion-productos">Información sobre productos</option>
					<option value="soporte-tecnico">Soporte técnico</option>
					<option value="otros">Otros</option>
				</select>
				<i class="fi icon fi-tr-ballot absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
				<span id="error-asuntoContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
			</div>
		</div>
	</div>

	<!-- Correo electrónico -->
	<div class="w-full">
		<label for="emailContacto" class="block mb-2">Correo electrónico <span class="text-primary">*</span></label>
		<div class="relative border-1 border-gray-400 rounded-full">
			<input class="ps-10 pr-4 py-4 w-full rounded-full" type="email" name="emailContacto" id="emailContacto" placeholder="" maxlength="100" autocomplete="email" />
			<i class="fi icon fi-tr-at absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
			<span id="error-emailContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
		</div>
	</div>

	<!-- Mensaje -->
	<div class="w-full">
		<label for="mensajeContacto" class="block mb-2">Mensaje</label>
		<div class="relative border-1 border-gray-400 rounded-2xl">
			<textarea class="ps-10 pr-4 py-4 w-full resize-none overflow-hidden" name="mensajeContacto" id="mensajeContacto" placeholder="" rows="1" maxlength="1000"></textarea>
			<i class="fi icon fi-tr-comment-alt-dots absolute top-5 left-4 transform text-gray-400"></i>
		</div>
	</div>

	<!-- Honeypot (campo oculto anti-spam) -->
	<input type="text" name="website" id="website" style="display:none" tabindex="-1" autocomplete="off" />

	<div class="pt-6">
		<p class="m-0">
			Autorizo a <strong class="font-semibold">INGESOFTNET S.A.S.</strong> el tratamiento de mis datos personales conforme a su
			<a href="/politica-de-privacidad" target="_blank" rel="noopener noreferrer" class="text-primary-dark hover:text-accent font-semibold transition-colors ease-in-out duration-300" title="Enlace a Política de privacidad">Política de privacidad</a>.
		</p>
	</div>

	<div class="collapse" id="polPriv">
		<div class="p-4 bg-gray-100 rounded-lg text-gray-700">
			<p>Para poder enviar tu mensaje debes leer y aceptar nuestra Política de privacidad.</p>
		</div>
	</div>

	<div class="flex flex-col lg:flex-row lg:items-center gap-6 justify-between flex-wrap">
		<div class="relative flex items-center gap-2">
			<div class="check">
				<input type="checkbox" data-collapse-toggle="polPriv" name="terminosContacto" id="terminosContacto" />
			</div>
			<label for="terminosContacto" class="cursor-pointer select-none"> He leído y acepto las política de privacidad. </label>
			<span id="error-terminosContacto" class="absolute top-full left-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
		</div>

		<!-- Botón enviar -->
		<div>
			<button type="submit" id="submitBtn" class="mt-4 lg:mt-0 flex items-center gap-4 bg-primary hover:bg-accent text-white font-semibold py-4 px-6 rounded-full cursor-pointer disabled:opacity-50 active:scale-95 disabled:cursor-not-allowed disabled:bg-primary disabled:active:scale-100 transition-all duration-300 ease-in-out group" disabled>
				<i class="fi icon fi-tr-paper-plane-top group-hover:rotate-45 transition-all duration-300 ease-in-out hover:delay-200 group-disabled:rotate-0"></i>
				<p class="m-0">Enviar mensaje</p>
			</button>
		</div>
	</div>
</form>

<!-- Modal success -->
<Modal id="modal" size="max-w-md">
	<div slot="modal-header">
		<hgroup class="py-4 text-center">
			<i class="fi icon fi-tr-comment-alt-check h-15 w-15 bg-primary-light text-primary text-xl flex items-center justify-center rounded-full mx-auto mb-6"></i>
			<p class="font-bold mb-2 text-2xl">¡Hemos recibido tu mensaje!</p>
			<p class="text-lg">Nos pondremos en contacto contigo pronto.</p>
		</hgroup>
	</div>
	<div slot="modal-body">
		<button class="flex items-center justify-center px-8 py-3 gap-3 cursor-pointer text-white bg-primary hover:bg-primary-dark rounded-full transition-all duration-300 ease-in-out mx-auto mt-6 lg:mt-10" data-modal-close>
			<span>Cerrar</span>
			<i class="fi icon fi-tr-x"></i>
		</button>
	</div>
</Modal>

<!-- Modal error -->
<Modal id="modalError" size="max-w-sm">
	<div slot="modal-header">
		<hgroup class="py-4 text-center">
			<i class="fi icon fi-tr-comment-exclamation h-15 w-15 bg-red-100 text-red-600 text-xl flex items-center justify-center rounded-full mx-auto mb-6"></i>
			<p class="font-bold mb-2 text-2xl">¡Error al enviar el mensaje!</p>
			<p class="text-lg">Por favor, intenta nuevamente más tarde.</p>
		</hgroup>
	</div>
	<div slot="modal-body">
		<button class="flex items-center justify-center px-8 py-3 gap-3 cursor-pointer text-white bg-red-600 hover:bg-red-800 rounded-full transition-all duration-300 ease-in-out mx-auto mt-6 lg:mt-10" data-modal-close>
			<span>Cerrar</span>
			<i class="fi icon fi-tr-x"></i>
		</button>
	</div>
</Modal>

<script>
	import { contactSchema } from '../utils/validations/contactSchema.js';

	document.addEventListener('DOMContentLoaded', () => {
		const form = document.getElementById('contactForm') as HTMLFormElement;
		const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
		const textarea = document.getElementById('mensajeContacto') as HTMLTextAreaElement;
		const telefonoInput = document.getElementById('telefonoContacto') as HTMLInputElement;

		// Restringir campo teléfono a solo números
		telefonoInput.addEventListener('input', (e) => {
			const target = e.target as HTMLInputElement;
			target.value = target.value.replace(/[^0-9]/g, '');
		});

		telefonoInput.addEventListener('keypress', (e) => {
			if (!/[0-9]/.test(e.key)) {
				e.preventDefault();
			}
		});

		// Prevenir envíos duplicados
		let isSubmitting = false;

		// Timestamp del último intento de envío (protección contra spam)
		let lastSubmitTime = 0;
		const MIN_SUBMIT_INTERVAL = 3000; // 3 segundos entre envíos

		// Función para limpiar errores
		function clearErrors() {
			const errorSpans = document.querySelectorAll('[id^="error-"]');
			errorSpans.forEach((span) => {
				span.textContent = '';
				span.classList.add('hidden');
			});

			const inputs = form.querySelectorAll('input, select, textarea');
			inputs.forEach((input) => input.classList.remove('error'));
		}

		// Función para mostrar errores
		function showError(fieldName: string, message: string) {
			const errorSpan = document.getElementById(`error-${fieldName}`);
			const input = document.getElementById(fieldName);

			if (errorSpan) {
				errorSpan.textContent = message;
				errorSpan.classList.remove('hidden');
			}

			if (input) {
				input.classList.add('error');
			}
		}

		// Función para sanitizar entrada básica (prevenir XSS básico)
		function sanitizeInput(str: string): string {
			return str.trim().replace(/[<>]/g, '');
		}

		// Manejar envío del formulario
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			// Prevenir doble envío
			if (isSubmitting) return;

			// Protección contra spam
			const now = Date.now();
			if (now - lastSubmitTime < MIN_SUBMIT_INTERVAL) {
				showError('nombreContacto', 'Por favor espera unos segundos antes de enviar nuevamente');
				return;
			}

			clearErrors();

			// Obtener datos del formulario
			const formData = new FormData(form);

			// Verificar honeypot (campo anti-spam)
			if (formData.get('website')) {
				console.warn('Posible spam detectado');
				return;
			}

			const data = {
				nombreContacto: sanitizeInput((formData.get('nombreContacto') as string) || ''),
				apellidoContacto: sanitizeInput((formData.get('apellidoContacto') as string) || ''),
				telefonoContacto: sanitizeInput((formData.get('telefonoContacto') as string) || ''),
				asuntoContacto: (formData.get('asuntoContacto') as string) || '',
				emailContacto: sanitizeInput((formData.get('emailContacto') as string) || ''),
				mensajeContacto: sanitizeInput((formData.get('mensajeContacto') as string) || ''),
				terminosContacto: formData.get('terminosContacto') === 'on',
			};

			// Validar con Zod
			const result = contactSchema.safeParse(data);

			if (!result.success) {
				const errors = result.error.flatten().fieldErrors;

				Object.keys(errors).forEach((fieldName) => {
					const errorMessages = errors[fieldName];
					if (errorMessages && errorMessages.length > 0) {
						showError(fieldName, errorMessages[0]);
					}
				});
				return;
			}

			// Marcar como enviando
			isSubmitting = true;
			lastSubmitTime = now;

			submitBtn.disabled = true;
			const buttonText = submitBtn.querySelector('p');
			if (buttonText) buttonText.textContent = 'Enviando...';

			// Crear FormData limpio para enviar
			const cleanFormData = new FormData();
			cleanFormData.append('nombreContacto', data.nombreContacto);
			cleanFormData.append('apellidoContacto', data.apellidoContacto);
			cleanFormData.append('telefonoContacto', data.telefonoContacto);
			cleanFormData.append('asuntoContacto', data.asuntoContacto);
			cleanFormData.append('emailContacto', data.emailContacto);
			cleanFormData.append('mensajeContacto', data.mensajeContacto);
			cleanFormData.append('terminosContacto', data.terminosContacto ? 'on' : '');

			try {
				const response = await fetch('/api/send-mail.php', {
					method: 'POST',
					body: cleanFormData,
					// Timeout de 10 segundos
					signal: AbortSignal.timeout(10000),
				});

				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}

				const result = await response.json();

				if (result.success) {
					(window as any)?.modalManager?.open();
					form.reset();

					// Resetear estado del checkbox
					const checkbox = document.getElementById('terminosContacto') as HTMLInputElement;
					if (checkbox) checkbox.checked = false;

					setTimeout(() => {
						(window as any)?.modalManager?.close();
					}, 5000);
				} else {
					throw new Error(result.error || 'Error desconocido');
				}
			} catch (error) {
				console.error('Error al enviar:', error);
				(window as any)?.modalErrorManager?.open();

				setTimeout(() => {
					(window as any)?.modalErrorManager?.close();
				}, 5000);
			} finally {
				isSubmitting = false;
				submitBtn.disabled = true; // Mantener deshabilitado hasta que acepte términos nuevamente
				if (buttonText) buttonText.textContent = 'Enviar mensaje';
			}
		});

		// Autoajuste de altura del textarea
		const minHeight = 120;
		const maxHeight = 350;

		function autoResize(this: HTMLTextAreaElement) {
			this.style.height = 'auto';
			const newHeight = Math.min(Math.max(this.scrollHeight, minHeight), maxHeight);
			this.style.height = newHeight + 'px';

			if (this.scrollHeight > maxHeight) {
				this.style.overflowY = 'auto';
			} else {
				this.style.overflowY = 'hidden';
			}
		}

		textarea.addEventListener('input', autoResize);
		autoResize.call(textarea);

		// Script collapse
		const COLLAPSE_DURATION = 300;
		const toggleCheckboxes = document.querySelectorAll<HTMLInputElement>('input[type="checkbox"][data-collapse-toggle]');

		function toggleCollapse(checkbox: HTMLInputElement, target: HTMLElement) {
			if (target.classList.contains('collapsing')) return;

			const shouldShow = !checkbox.checked;

			if (shouldShow) {
				target.classList.remove('collapse');
				target.classList.add('collapsing');
				target.style.height = '0';
				target.style.transition = `height ${COLLAPSE_DURATION}ms ease-in-out`;

				requestAnimationFrame(() => {
					target.style.height = target.scrollHeight + 'px';
				});

				setTimeout(() => {
					target.classList.remove('collapsing');
					target.classList.add('collapse', 'show');
					target.style.height = '';
					target.style.transition = '';
				}, COLLAPSE_DURATION);
			} else {
				target.style.height = target.scrollHeight + 'px';
				target.classList.remove('collapse', 'show');
				target.classList.add('collapsing');
				target.style.transition = `height ${COLLAPSE_DURATION}ms ease-in-out`;

				requestAnimationFrame(() => {
					target.style.height = '0';
				});

				setTimeout(() => {
					target.classList.remove('collapsing');
					target.classList.add('collapse');
					target.style.height = '';
					target.style.transition = '';
				}, COLLAPSE_DURATION);
			}
		}

		toggleCheckboxes.forEach((checkbox) => {
			const targetId = checkbox.getAttribute('data-collapse-toggle');
			if (!targetId) return;

			const target = document.getElementById(targetId);
			if (!target) return;

			checkbox.addEventListener('change', function () {
				toggleCollapse(checkbox, target);

				const submitButton = document.querySelector('button[type="submit"]') as HTMLButtonElement;
				if (submitButton) {
					submitButton.disabled = !checkbox.checked;
				}
			});
		});
	});
</script>

<style>
	select,
	textarea,
	input {
		outline: none;
	}

	select {
		border-right: 20px solid transparent;
	}

	select:has(option:disabled:checked) {
		color: var(--color-gray-400);
	}

	select:has(option:not(:disabled):checked) {
		color: var(--color-text);
	}

	option {
		color: var(--color-text);
	}

	option:disabled {
		color: var(--color-gray-400);
	}

	.collapse {
		visibility: hidden;
		overflow: hidden;
		height: 0;
	}

	.collapse.show {
		height: auto;
		visibility: visible;
	}

	.collapsing {
		display: block;
		overflow: hidden;
	}

	.check {
		position: relative;
		z-index: 1;
		width: 25px;
		height: 25px;
		min-width: 25px;
		min-height: 25px;
		border: 1px solid var(--color-gray-400);
		cursor: pointer;
		border-radius: 4px;
		transition:
			border-color 0.3s ease-in-out,
			background-color 0.3s ease-in-out;
	}

	.check::after {
		content: '';
		position: absolute;
		color: #fff;
		top: 5px;
		left: 9px;
		width: 5px;
		height: 10px;
		border: solid #fff;
		border-width: 0 2px 2px 0;
		transform: scale(0) rotate(45deg);
		transition: transform 0.3s ease-in-out;
	}

	.check input {
		position: absolute;
		z-index: 10;
		width: 100%;
		height: 100%;
		opacity: 0;
		cursor: pointer;
	}

	.check:has(input:checked) {
		border-color: var(--color-primary);
		background-color: var(--color-primary);
	}

	.check:has(input:checked)::after {
		transform: scale(1) rotate(45deg);
	}

	input[type='number'],
	input[type='tel'] {
		-moz-appearance: textfield;
	}

	input[type='number']::-webkit-inner-spin-button,
	input[type='number']::-webkit-outer-spin-button {
		-webkit-appearance: none;
		margin: 0;
	}
</style>
