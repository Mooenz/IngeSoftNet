<div id="formMessages"></div>

<form id="contactForm" class="flex flex-col gap-6" novalidate>
	<div class="flex flex-col lg:flex-row lg:items-center gap-6">
		<!-- Nombres -->
		<div class="w-full">
			<label for="nombreContacto" class="block mb-2">Nombres <span class="text-primary">*</span></label>
			<div class="relative border-1 border-gray-400 rounded-full">
				<input class="ps-10 pr-4 py-4 w-full rounded-full" type="text" name="nombreContacto" id="nombreContacto" placeholder="" />
				<i class="fi fi-rr-user absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
				<span id="error-nombreContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
			</div>
		</div>

		<!-- Apellidos -->
		<div class="w-full">
			<label for="apellidoContacto" class="block mb-2">Apellidos <span class="text-primary">*</span></label>
			<div class="relative border-1 border-gray-400 rounded-full">
				<input class="ps-10 pr-4 py-4 w-full rounded-full" type="text" name="apellidoContacto" id="apellidoContacto" placeholder="" />
				<i class="fi fi-rr-user absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
				<span id="error-apellidoContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
			</div>
		</div>
	</div>

	<div class="flex flex-col lg:flex-row lg:items-center gap-6">
		<!-- tel√©fono -->
		<div class="w-full">
			<label for="telefonoContacto" class="block mb-2">Tel√©fono <span class="text-primary">*</span></label>
			<div class="relative border-1 border-gray-400 rounded-full">
				<input class="ps-10 pr-4 py-4 w-full rounded-full" type="number" name="telefonoContacto" id="telefonoContacto" placeholder="" />
				<i class="fi fi-rr-phone-call absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
				<span id="error-telefonoContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
			</div>
		</div>

		<!-- Asunto-->
		<div class="w-full">
			<label for="asuntoContacto" class="block mb-2">Asunto <span class="text-primary">*</span></label>
			<div class="relative border-1 border-gray-400 rounded-full ps-10">
				<select class="pr-4 py-4 w-full" name="asuntoContacto" id="asuntoContacto">
					<option value="" disabled selected></option>
					<option value="informacion-productos">Informaci√≥n sobre productos</option>
					<option value="soporte-tecnico">Soporte t√©cnico</option>
					<option value="otros">Otros</option>
				</select>
				<i class="fi fi-rr-bookmark absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
				<span id="error-asuntoContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
			</div>
		</div>
	</div>

	<!-- Correo electr√≥nico -->
	<div class="w-full">
		<label for="emailContacto" class="block mb-2">Correo electr√≥nico <span class="text-primary">*</span></label>
		<div class="relative border-1 border-gray-400 rounded-full">
			<input class="ps-10 pr-4 py-4 w-full rounded-full" type="email" name="emailContacto" id="emailContacto" placeholder="" />
			<i class="fi fi-rr-envelope absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400"></i>
			<span id="error-emailContacto" class="absolute top-full right-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
		</div>
	</div>

	<!-- Mensaje -->
	<div class="w-full">
		<label for="mensajeContacto" class="block mb-2">Mensaje</label>
		<div class="relative border-1 border-gray-400 rounded-2xl">
			<textarea class="ps-10 pr-4 py-4 w-full resize-none overflow-hidden" name="mensajeContacto" id="mensajeContacto" placeholder="" rows="1"></textarea>
			<i class="fi fi-rr-comment absolute top-5 left-4 transform text-gray-400"></i>
		</div>
	</div>

	<div class="pt-6">
		<p class="m-0">
			Autorizo a <strong class="font-semibold">INGESOFTNET S.A.S.</strong> el tratamiento de mis datos personales conforme a su
			<a href="/politica-de-privacidad.html" class="text-primary-dark hover:text-accent font-semibold transition-colors ease-in-out duration-300" title="Enlace a Pol√≠tica de privacidad">Pol√≠tica de privacidad</a>.
		</p>
	</div>

	<div class="collapse" id="polPriv">
		<div class="p-4 bg-gray-100 rounded-lg text-gray-700">
			<p>Para poder enviar tu mensaje debes leer y aceptar nuestra Pol√≠tica de privacidad.</p>
		</div>
	</div>

	<div class="flex flex-col lg:flex-row lg:items-center gap-6 justify-between flex-wrap">
		<div class="relative w-100 flex items-center gap-2">
			<div class="check">
				<input type="checkbox" data-collapse-toggle="polPriv" name="terminosContacto" id="terminosContacto" />
			</div>
			<label for="terminosContacto" class="cursor-pointer select-none"> He le√≠do y acepto las pol√≠tica de privacidad. </label>
			<span id="error-terminosContacto" class="absolute top-full left-0 text-white bg-red-500 text-sm hidden px-2 rounded-md"></span>
		</div>

		<!-- Bot√≥n enviar -->
		<div>
			<button type="submit" id="submitBtn" class="mt-4 lg:mt-0 flex items-center gap-4 bg-primary hover:bg-accent text-white font-semibold py-4 px-6 rounded-full cursor-pointer disabled:opacity-50 active:scale-95 disabled:cursor-not-allowed disabled:bg-primary disabled:active:scale-100 transition-all duration-300 ease-in-out group" disabled>
				<i class="fi fi-rr-paper-plane group-hover:rotate-45 transition-all duration-300 ease-in-out hover:delay-200 group-disabled:rotate-0"></i>
				<p class="m-0">Enviar mensaje</p>
			</button>
		</div>
	</div>
</form>

<script>
	import { contactSchema } from '../utils/validations/contactSchema.js';

	// Strongly-typed element references to satisfy TypeScript
	const form = document.getElementById('contactForm') as HTMLFormElement;
	const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
	const formMessages = document.getElementById('formMessages') as HTMLElement;

	// Funci√≥n para limpiar errores
	function clearErrors() {
		const errorSpans = document.querySelectorAll('[id^="error-"]');
		errorSpans.forEach((span) => {
			span.textContent = '';
			span.classList.add('hidden');
		});

		const inputs = form.querySelectorAll('input, select, textarea');
		inputs.forEach((input) => input.classList.remove('error'));
	}

	// Funci√≥n para mostrar errores
	function showError(fieldName, message) {
		const errorSpan = document.getElementById(`error-${fieldName}`);
		const input = document.getElementById(fieldName);

		if (errorSpan) {
			errorSpan.textContent = message;
			errorSpan.classList.remove('hidden');
		}

		if (input) {
			input.classList.add('error');
		}
	}

	// Funci√≥n para mostrar mensaje general
	function showMessage(message, type = 'success') {
		const bgColor = type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
		formMessages.innerHTML = `
			<div class="p-4 ${bgColor} rounded-lg mb-6">
				${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}
			</div>
		`;

		// Auto-ocultar despu√©s de 5 segundos
		setTimeout(() => {
			formMessages.innerHTML = '';
		}, 5000);
	}

	// Manejar env√≠o del formulario
	form.addEventListener('submit', async (e) => {
		e.preventDefault();

		// Limpiar errores anteriores
		clearErrors();

		// Obtener datos del formulario
		const formData = new FormData(form);
		const data = {
			nombreContacto: formData.get('nombreContacto'),
			apellidoContacto: formData.get('apellidoContacto'),
			telefonoContacto: formData.get('telefonoContacto'),
			asuntoContacto: formData.get('asuntoContacto'),
			emailContacto: formData.get('emailContacto'),
			terminosContacto: formData.get('terminosContacto') === 'on',
		};

		// Validar con Zod
		const result = contactSchema.safeParse(data);

		if (!result.success) {
			const errors = result.error.flatten().fieldErrors;

			Object.keys(errors).forEach((fieldName) => {
				const errorMessages = errors[fieldName];
				if (errorMessages && errorMessages.length > 0) {
					// Tomar siempre el primer mensaje
					showError(fieldName, errorMessages[0]);
					console.log(`Campo: ${fieldName}, Error: ${errorMessages[0]}`); // üëà Debug
				}
			});

			// showMessage('Por favor corrige los errores en el formulario', 'error');
			return;
		}

		// Datos v√°lidos, deshabilitar bot√≥n
		submitBtn.disabled = true;
		submitBtn.querySelector('p').textContent = 'Enviando...';

		try {
			// TODO: Aqu√≠ enviar√≠as a tu backend o servicio externo
			// Ejemplo con un servicio externo como Formspree:
			/*
			const response = await fetch('https://formspree.io/f/TU_ID', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(result.data)
			});
			
			if (!response.ok) throw new Error('Error al enviar');
			*/

			// Simulaci√≥n de env√≠o (remover esto en producci√≥n)
			await new Promise((resolve) => setTimeout(resolve, 1500));

			console.log('‚úÖ Datos validados:', result.data);

			// showMessage('¬°Mensaje enviado correctamente! Nos pondremos en contacto contigo pronto.', 'success');
			form.reset();
		} catch (error) {
			console.error('Error al enviar:', error);
			showMessage('Ocurri√≥ un error al enviar el mensaje. Por favor, intenta nuevamente.', 'error');
		} finally {
			submitBtn.disabled = false;
			submitBtn.querySelector('p').textContent = 'Enviar mensaje';
		}
	});
	/** */
	/** Autoajuste de altura del textarea */
	const textarea = document.getElementById('mensajeContacto');
	const minHeight = 120; // Altura m√≠nima en px
	const maxHeight = 350; // Altura m√°xima en px

	function autoResize() {
		this.style.height = 'auto';
		const newHeight = Math.min(Math.max(this.scrollHeight, minHeight), maxHeight);
		this.style.height = newHeight + 'px';

		// Mostrar scroll si llega al m√°ximo
		if (this.scrollHeight > maxHeight) {
			this.style.overflowY = 'auto';
		} else {
			this.style.overflowY = 'hidden';
		}
	}

	textarea.addEventListener('input', autoResize);

	// Ajustar al cargar si ya tiene contenido
	autoResize.call(textarea);

	/** */
	/** script collapse */
	const COLLAPSE_DURATION = 300;

	// Obtener todos los checkboxes con data-collapse-toggle
	const toggleCheckboxes = document.querySelectorAll<HTMLInputElement>('input[type="checkbox"][data-collapse-toggle]');

	function toggleCollapse(checkbox: HTMLInputElement, target: HTMLElement) {
		// Prevenir m√∫ltiples clics mientras est√° animando
		if (target.classList.contains('collapsing')) return;

		// Si est√° CHECKED = ocultar, si est√° UNCHECKED = mostrar
		const shouldShow = !checkbox.checked;

		if (shouldShow) {
			// Expandir (cuando se quita el check)
			target.classList.remove('collapse');
			target.classList.add('collapsing');
			target.style.height = '0';
			target.style.transition = `height ${COLLAPSE_DURATION}ms ease-in-out`;

			requestAnimationFrame(() => {
				target.style.height = target.scrollHeight + 'px';
			});

			setTimeout(() => {
				target.classList.remove('collapsing');
				target.classList.add('collapse', 'show');
				target.style.height = '';
				target.style.transition = '';
			}, COLLAPSE_DURATION);
		} else {
			// Colapsar (cuando se marca el check)
			target.style.height = target.scrollHeight + 'px';
			target.classList.remove('collapse', 'show');
			target.classList.add('collapsing');
			target.style.transition = `height ${COLLAPSE_DURATION}ms ease-in-out`;

			requestAnimationFrame(() => {
				target.style.height = '0';
			});

			setTimeout(() => {
				target.classList.remove('collapsing');
				target.classList.add('collapse');
				target.style.height = '';
				target.style.transition = '';
			}, COLLAPSE_DURATION);
		}
	}

	toggleCheckboxes.forEach((checkbox) => {
		const targetId = checkbox.getAttribute('data-collapse-toggle');
		const target = document.getElementById(targetId);

		if (!target) return;

		// Escuchar cambios en el checkbox
		checkbox.addEventListener('change', function () {
			toggleCollapse(checkbox, target);

			// Activamos el bot√≥n de enviar mensaje
			const submitButton = document.querySelector('button[type="submit"]') as HTMLButtonElement;
			if (checkbox.checked) {
				submitButton.disabled = false;
			} else {
				submitButton.disabled = true;
			}
		});
	});
</script>

<style>
	select,
	textarea,
	input {
		outline: none;
	}

	select {
		border-right: 20px solid transparent;
	}

	/* Color del select */
	select:has(option:disabled:checked) {
		color: var(--color-gray-400); /* placeholder gris claro */
	}

	select:has(option:not(:disabled):checked) {
		color: var(--color-text); /* texto seleccionado oscuro */
	}

	option {
		color: var(--color-text);
	}

	option:disabled {
		color: var(--color-gray-400);
	}

	/* Estilos para el colapso */
	.collapse {
		visibility: hidden;
		overflow: hidden;
		height: 0;
	}

	.collapse.show {
		height: auto;
		visibility: visible;
	}

	.collapsing {
		display: block;
		overflow: hidden;
	}

	/* Checkbox */
	.check {
		position: relative;
		z-index: 1;
		width: 20px;
		height: 20px;
		border: 1px solid var(--color-gray-400);
		cursor: pointer;
		border-radius: 4px;
		transition: border-color 0.3s ease-in-out;
	}

	.check::after {
		content: '\f3c8';
		position: absolute;
		z-index: -1;
		inset: -1px;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 4px;
		font-size: 0.625rem;
		font-family: uicons-regular-rounded !important;
		color: #fff;
		background-color: var(--color-primary);
		transform: scale(0);
		transition: transform 0.3s ease-in-out;
	}

	.check input {
		position: absolute;
		z-index: 10;
		width: 100%;
		height: 100%;
		opacity: 0;
		cursor: pointer;
	}

	.check:has(input:checked) {
		border-color: var(--color-primary);
	}

	.check:has(input:checked)::after {
		transform: scale(1);
	}

	/* Input tipo number */
	input[type='number'] {
		-moz-appearance: textfield;
	}

	input[type='number']::-webkit-inner-spin-button,
	input[type='number']::-webkit-outer-spin-button {
		-webkit-appearance: none;
		margin: 0;
	}
</style>
